<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Le Micro Climat du Balcon de Jonathan - IoT</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background-color: #111827; }
</style>
</head>
<body class="font-sans text-gray-100">

<!-- Top Navigation -->
<header class="bg-gray-800 shadow-lg">
  <div class="container mx-auto flex items-center justify-between p-4">
    <h1 class="text-2xl font-bold text-green-400">Mais alors, quel temps fait-il sur le balcon de Jonathan?</h1>
    <p id="lastUpdate" class="text-gray-400">Les dernières données météorologiques datent de: --</p>
  </div>
</header>

<!-- Main Content -->
<main class="container mx-auto p-6">
  <!-- Cards -->
<!-- Cards Grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    
    <!-- Temperature -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Température</h2>
      <p id="tempValue" class="text-2xl sm:text-3xl font-bold text-green-400">-- °C</p>
    </div>

    <!-- Pression -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Pression</h2>
      <p id="pressureValue" class="text-2xl sm:text-3xl font-bold text-red-400">-- hPa</p>
    </div>

    <!-- Humidite -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Hygrométrie</h2>
      <p id="moistureValue" class="text-2xl sm:text-3xl font-bold text-teal-400">-- %</p>
    </div>

    <!-- Indice de qualite de l'air -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">IAQ</h2>
      <p id="iaqValue" class="text-2xl sm:text-3xl font-bold text-blue-400">--</p>
    </div>

    <!-- precision de l'indice IAQ -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">IAQ précision</h2>
      <p id="iaqprecisionValue" class="text-2xl sm:text-3xl font-bold text-yellow-400">--</p>
    </div>

    <!-- co2 -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Quantité de CO2</h2>
      <p id="co2value" class="text-2xl sm:text-3xl font-bold text-pink-400">--</p>
    </div>

    <!-- cov -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Qualité de COV</h2>
      <p id="vocValue" class="text-2xl sm:text-3xl font-bold text-cyan-400">--</p>
    </div>

  </div>

  <!-- Chart Section -->
  <div class="bg-gray-800 rounded-xl shadow-lg p-6">
    <h2 class="text-xl font-semibold mb-4">Tu te rends comptes ? On a aussi accès à l'historique !</h2>
    <canvas id="dataChart"></canvas>
  </div>
</main>

<script>
const apiKey = "EAG5JSOPGG6TUX2V";
const channelID = "3110199";
const results = 100000;
let chart;

// Fetch data from ThingSpeak
async function getData() {
  const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${apiKey}&results=${results}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('Network response was not ok: ' + res.status);
  const data = await res.json();
  return data.feeds;
}

// Update dashboard and chart
async function updateDashboard() {
  try {
    const feeds = await getData();
    if (!Array.isArray(feeds) || feeds.length === 0) {
      document.getElementById('lastUpdate').innerText = "Aucune donnée disponible.";
      return;
    }

    const latest = feeds[feeds.length - 1];

    // Defensive checks before updating DOM
    document.getElementById('tempValue').innerText = isFinite(parseFloat(latest.field1)) ? parseFloat(latest.field1).toFixed(2) + " °C" : "-- °C";
    document.getElementById('pressureValue').innerText = isFinite(parseFloat(latest.field2)) ? parseFloat(latest.field2).toFixed(2) + " hPa" : "-- hPa";
    document.getElementById('moistureValue').innerText = isFinite(parseFloat(latest.field3)) ? parseFloat(latest.field3).toFixed(2) + " %" : "-- %";
    document.getElementById('iaqValue').innerText = isFinite(parseFloat(latest.field4)) ? parseFloat(latest.field4).toFixed(2) : "--";
    document.getElementById('iaqprecisionValue').innerText = isFinite(parseFloat(latest.field5)) ? parseFloat(latest.field5).toFixed(2) : "--";
    document.getElementById('co2value').innerText = isFinite(parseFloat(latest.field6)) ? parseFloat(latest.field6).toFixed(2) + " ppm" : "--";
    document.getElementById('vocValue').innerText = isFinite(parseFloat(latest.field7)) ? parseFloat(latest.field7).toFixed(2) + " ppm" : "--";

    if (latest.created_at) {
      document.getElementById('lastUpdate').innerText = "Les dernières données météorologiques datent de : " + new Date(latest.created_at).toLocaleString();
    } else {
      document.getElementById('lastUpdate').innerText = "Dernière mise à jour : --";
    }

    // (Optional) update chart here if you want to visualize history
    // Example placeholder: initialize chart once and update datasets on subsequent calls
  } catch (err) {
    console.error('Failed to update dashboard:', err);
    document.getElementById('lastUpdate').innerText = "Erreur lors de la récupération des données.";
  }
}

// Initial load and periodic refresh
updateDashboard();
setInterval(updateDashboard, 30000);
</script>
</body>
</html>
