<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PlantSaver Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #111827;
      color: #f9fafb;
      font-family: 'Inter', sans-serif;
    }

    .iaq-segment {
      transition: transform 0.25s ease, filter 0.25s ease, fill 0.25s ease;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-6 space-y-6">

  <h1 class="text-3xl font-bold text-green-400 mb-4">üåø PlantSaver Dashboard</h1>

  <!-- Cards Grid -->
  <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-6xl">

    <!-- Temp -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Temp√©rature</h2>
      <p id="tempValue" class="text-3xl font-bold text-green-400">-- ¬∞C</p>
    </div>

    <!-- Pressure -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Pression</h2>
      <p id="pressureValue" class="text-3xl font-bold text-red-400">-- hPa</p>
    </div>

    <!-- Humidity -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Hygrom√©trie</h2>
      <p id="moistureValue" class="text-3xl font-bold text-teal-400">-- %</p>
    </div>

    <!-- IAQ Gauge -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-3 text-sm sm:text-base">Indice IAQ</h2>

      <div id="iaqCard" class="relative w-[140px] h-[140px] flex items-center justify-center">
        <svg id="iaqGauge" width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"></svg>

        <!-- Center Value -->
        <div id="iaqValueContainer" class="absolute flex flex-col items-center justify-center">
          <p id="iaqValue" class="text-4xl font-bold text-white">--</p>
          <p id="iaqGrade" class="text-sm text-gray-300 mt-1">--</p>
        </div>
      </div>
    </div>

    <!-- IAQ precision -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">IAQ pr√©cision</h2>
      <p id="iaqprecisionValue" class="text-3xl font-bold text-yellow-400">--</p>
    </div>

    <!-- CO2 -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Quantit√© de CO‚ÇÇ</h2>
      <p id="co2value" class="text-3xl font-bold text-pink-400">--</p>
    </div>

    <!-- VOC -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Qualit√© de COV</h2>
      <p id="vocValue" class="text-3xl font-bold text-cyan-400">--</p>
    </div>

  </main>

  <!-- üß† Scripts -->
  <script>
    // --- IAQ Gauge Setup ---
    const iaqGrades = [
      { max: 50, label: "Excellent", color: "#22c55e" },
      { max: 100, label: "Bon", color: "#84cc16" },
      { max: 150, label: "Mod√©r√©", color: "#eab308" },
      { max: 200, label: "M√©diocre", color: "#f97316" },
      { max: 500, label: "Mauvais", color: "#ef4444" }
    ];

    function iaqGradeIndexForValue(v) {
      for (let i = 0; i < iaqGrades.length; i++) {
        if (v <= iaqGrades[i].max) return i;
      }
      return -1;
    }

    // --- Draw IAQ Circular Gauge ---
    function drawIAQGauge(value) {
      const svg = document.getElementById("iaqGauge");
      if (!svg) return;
      svg.innerHTML = "";

      const cx = 60, cy = 60, rOuterBase = 44;
      let startAngle = -90;
      const totalDegrees = 360;

      const totalMax = iaqGrades[iaqGrades.length - 1].max;
      const arcDegreesPerUnit = totalDegrees / totalMax;

      // Draw color segments
      iaqGrades.forEach((g, i) => {
        const prevMax = i === 0 ? 0 : iaqGrades[i - 1].max;
        const range = g.max - prevMax;
        const sweep = range * arcDegreesPerUnit;
        const endAngle = startAngle + sweep;

        const x1 = cx + rOuterBase * Math.cos((Math.PI / 180) * startAngle);
        const y1 = cy + rOuterBase * Math.sin((Math.PI / 180) * startAngle);
        const x2 = cx + rOuterBase * Math.cos((Math.PI / 180) * endAngle);
        const y2 = cy + rOuterBase * Math.sin((Math.PI / 180) * endAngle);

        const largeArc = sweep > 180 ? 1 : 0;

        const pathData = `
          M ${x1} ${y1}
          A ${rOuterBase} ${rOuterBase} 0 ${largeArc} 1 ${x2} ${y2}
        `;

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", pathData.trim());
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", g.color);
        path.setAttribute("stroke-width", "8");
        path.setAttribute("class", "iaq-segment");
        svg.appendChild(path);

        startAngle = endAngle;
      });

      // Highlight active range
      if (!isNaN(value)) {
        const gi = iaqGradeIndexForValue(value);
        if (gi >= 0) {
          const glowColor = iaqGrades[gi].color;
          svg.style.filter = `drop-shadow(0 0 10px ${glowColor}88)`;
        }
      }
    }

    // --- Fetch data & update dashboard ---
    async function updateDashboard() {
      try {
        const res = await fetch("https://api.thingspeak.com/channels/2612104/feeds.json?results=1");
        const data = await res.json();
        const latest = data.feeds[0];

        // Temp
        const tempRaw = parseFloat(latest.field1);
        document.getElementById("tempValue").innerText = isFinite(tempRaw) ? tempRaw.toFixed(1) + " ¬∞C" : "-- ¬∞C";

        // Pressure
        const pressRaw = parseFloat(latest.field2);
        document.getElementById("pressureValue").innerText = isFinite(pressRaw) ? pressRaw.toFixed(0) + " hPa" : "-- hPa";

        // Humidity
        const humRaw = parseFloat(latest.field3);
        document.getElementById("moistureValue").innerText = isFinite(humRaw) ? humRaw.toFixed(0) + " %" : "-- %";

        // IAQ
        const iaqRaw = parseFloat(latest.field4);
        const iaqEl = document.getElementById("iaqValue");
        const iaqGradeEl = document.getElementById("iaqGrade");

        if (isFinite(iaqRaw)) {
          const gi = iaqGradeIndexForValue(iaqRaw);
          if (gi >= 0) {
            const g = iaqGrades[gi];
            iaqEl.innerText = iaqRaw.toFixed(0);
            iaqEl.style.color = g.color;
            iaqGradeEl.innerText = g.label;
            iaqGradeEl.style.color = g.color;
          }
        } else {
          iaqEl.innerText = "--";
          iaqGradeEl.innerText = "--";
        }

        // ‚úÖ Draw the IAQ gauge ring
        drawIAQGauge(iaqRaw);

        // IAQ precision
        const iaqPrec = parseFloat(latest.field5);
        document.getElementById("iaqprecisionValue").innerText = isFinite(iaqPrec) ? iaqPrec.toFixed(0) : "--";

        // CO2
        const co2Raw = parseFloat(latest.field6);
        document.getElementById("co2value").innerText = isFinite(co2Raw) ? co2Raw.toFixed(0) + " ppm" : "--";

        // VOC
        const vocRaw = parseFloat(latest.field7);
        document.getElementById("vocValue").innerText = isFinite(vocRaw) ? vocRaw.toFixed(0) + " ppb" : "--";

      } catch (err) {
        console.error("Erreur de mise √† jour:", err);
      }
    }

    // Auto-refresh every 30 seconds
    updateDashboard();
    setInterval(updateDashboard, 30000);
  </script>
</body>
</html>
