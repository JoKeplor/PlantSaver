<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PlantSaver IoT</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background-color: #111827; }
</style>
</head>
<body class="font-sans text-gray-100">

<!-- Top Navigation -->
<header class="bg-gray-800 shadow-lg">
  <div class="container mx-auto flex items-center justify-between p-4">
    <h1 class="text-2xl font-bold text-green-400">ðŸŒ± PlantSaver Dashboard</h1>
    <p id="lastUpdate" class="text-gray-400">Last update: --</p>
  </div>
</header>

<!-- Main Content -->
<main class="container mx-auto p-6">
  <!-- Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2">Soil Moisture</h2>
      <p id="moistureValue" class="text-3xl font-bold text-green-400">-- %</p>
    </div>
    <div class="bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2">Temperature</h2>
      <p id="tempValue" class="text-3xl font-bold text-red-400">-- Â°C</p>
    </div>
    <div class="bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2">Pressure</h2>
      <p id="pressureValue" class="text-3xl font-bold text-blue-400">-- hPa</p>
    </div>
    <div class="bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2">Humidity</h2>
      <p id="humidityValue" class="text-3xl font-bold text-yellow-400">-- %</p>
    </div>
  </div>

  <!-- Chart Section -->
  <div class="bg-gray-800 rounded-xl shadow-lg p-6">
    <h2 class="text-xl font-semibold mb-4">Environmental Data</h2>

    <!-- Selection dropdowns -->
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
      <div>
        <label for="variableSelect" class="block text-gray-300 mb-1">Select Variable</label>
        <select id="variableSelect" class="bg-gray-700 text-gray-200 p-2 rounded-lg">
          <option value="temp">Temperature (Â°C)</option>
          <option value="pressure">Pressure (hPa)</option>
          <option value="humidity">Humidity (%)</option>
          <option value="moisture">Soil Moisture (%)</option>
        </select>
      </div>
      <div>
        <label for="timeRange" class="block text-gray-300 mb-1">Select Time Range</label>
        <select id="timeRange" class="bg-gray-700 text-gray-200 p-2 rounded-lg">
          <option value="hour">Last Hour</option>
          <option value="day">Last Day</option>
          <option value="week" selected>Last Week</option>
          <option value="month">Last Month</option>
          <option value="year">Last Year</option>
        </select>
      </div>
      <div class="flex items-center mt-1">
        <input type="checkbox" id="smoothToggle" class="accent-green-500 mr-2" checked>
        <label for="smoothToggle" class="text-gray-300">Smooth line</label>
      </div>
    </div>

    <canvas id="dataChart"></canvas>
  </div>
</main>

<script>
const apiKey = "EAG5JSOPGG6TUX2V";
const channelID = "3110199";
const results = 100000;
let chart;

// Fetch data from ThingSpeak
async function getData() {
  const res = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${apiKey}&results=${results}`);
  const data = await res.json();
  return data.feeds;
}

function filterByTimeRange(feeds, range) {
  const now = new Date();
  let cutoff;
  switch (range) {
    case "hour": cutoff = new Date(now - 60 * 60 * 1000); break;
    case "day": cutoff = new Date(now - 24 * 60 * 60 * 1000); break;
    case "week": cutoff = new Date(now - 7 * 24 * 60 * 60 * 1000); break;
    case "month": cutoff = new Date(now - 30 * 24 * 60 * 60 * 1000); break;
    case "year": cutoff = new Date(now - 365 * 24 * 60 * 60 * 1000); break;
  }
  return feeds.filter(f => new Date(f.created_at) > cutoff);
}

// Format timestamps for better readability on X axis
function formatTickLabel(date, range) {
  const d = new Date(date);
  switch (range) {
    case "hour":
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    case "day":
      return d.getHours() % 2 === 0 && d.getMinutes() < 5
        ? d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
        : "";
    case "week":
      return d.getHours() === 12
        ? d.toLocaleDateString([], { weekday: "short" })
        : "";
    case "month":
      return d.getDate() % 5 === 0
        ? d.toLocaleDateString([], { day: "numeric", month: "short" })
        : "";
    case "year":
      return d.getDate() === 1 && d.getMonth() % 2 === 0
        ? d.toLocaleDateString([], { month: "short" })
        : "";
    default:
      return "";
  }
}

// Optional smoothing (moving average)
function smoothData(data, windowSize = 5) {
  if (!document.getElementById("smoothToggle").checked) return data;
  const smoothed = [];
  for (let i = 0; i < data.length; i++) {
    const start = Math.max(0, i - windowSize);
    const subset = data.slice(start, i + 1).map(v => parseFloat(v)).filter(v => !isNaN(v));
    const avg = subset.reduce((a, b) => a + b, 0) / subset.length;
    smoothed.push(avg.toFixed(2));
  }
  return smoothed;
}

// Update dashboard and chart
async function updateDashboard() {
  const feeds = await getData();
  const latest = feeds[feeds.length - 1];

  // Update live values
  document.getElementById('moistureValue').innerText = parseFloat(latest.field5).toFixed(2) + " %";
  document.getElementById('tempValue').innerText = parseFloat(latest.field2).toFixed(2) + " Â°C";
  document.getElementById('pressureValue').innerText = parseFloat(latest.field3).toFixed(2) + " hPa";
  document.getElementById('humidityValue').innerText = parseFloat(latest.field4).toFixed(2) + " %";
  document.getElementById('lastUpdate').innerText = "Last update: " + new Date(latest.created_at).toLocaleString();

  updateChart(feeds);
}

function updateChart(feeds) {
  const variable = document.getElementById("variableSelect").value;
  const timeRange = document.getElementById("timeRange").value;
  const filtered = filterByTimeRange(feeds, timeRange);

  let label, color, rawData;
  switch (variable) {
    case "temp": label = "Temperature (Â°C)"; color = "#EF4444"; rawData = filtered.map(f => f.field2); break;
    case "pressure": label = "Pressure (hPa)"; color = "#3B82F6"; rawData = filtered.map(f => f.field3); break;
    case "humidity": label = "Humidity (%)"; color = "#FACC15"; rawData = filtered.map(f => f.field4); break;
    case "moisture": label = "Soil Moisture (%)"; color = "#10B981"; rawData = filtered.map(f => f.field5); break;
  }

  const data = smoothData(rawData);
  const labels = filtered.map(f => new Date(f.created_at));
  const ctx = document.getElementById('dataChart').getContext('2d');

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label,
        data,
        borderColor: color,
        tension: 0.4,
        fill: false,
        pointRadius: 1.2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#ffffff' } }
      },
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'minute',
            displayFormats: { minute: 'HH:mm' }
          },
          ticks: {
            color: '#ffffff',
            callback: function(value, index, values) {
              return formatTickLabel(labels[index], timeRange);
            }
          },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        y: {
          ticks: { color: '#ffffff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        }
      }
    }
  });
}

// Event listeners
["variableSelect", "timeRange", "smoothToggle"].forEach(id => {
  document.getElementById(id).addEventListener('change', updateDashboard);
});

// Initial load and refresh
updateDashboard();
setInterval(updateDashboard, 30000);
</script>
</body>
</html>
