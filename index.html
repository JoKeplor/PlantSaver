<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Le Micro Climat du Balcon de Jonathan - IoT</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background-color: #111827; }
</style>
</head>
<body class="font-sans text-gray-100">

<!-- Top Navigation -->
<header class="bg-gray-800 shadow-lg">
  <div class="container mx-auto flex items-center justify-between p-4">
    <h1 class="text-2xl font-bold text-green-400">Mais alors, quel temps fait-il sur le balcon de Jonathan?</h1>
    <p id="lastUpdate" class="text-gray-400">Les dernières données météorologiques datent de: --</p>
  </div>
</header>

<!-- Main Content -->
<main class="container mx-auto p-6">
  <!-- Cards -->
<!-- Cards Grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    
    <!-- Temperature -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Température</h2>
      <p id="tempValue" class="text-2xl sm:text-3xl font-bold text-green-400">-- °C</p>
    </div>

    <!-- Pression -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Pression</h2>
      <p id="pressureValue" class="text-2xl sm:text-3xl font-bold text-red-400">-- hPa</p>
    </div>

    <!-- Humidite -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Hygrométrie</h2>
      <p id="moistureValue" class="text-2xl sm:text-3xl font-bold text-teal-400">-- %</p>
    </div>

    <!-- Indice de qualite de l'air -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">IAQ</h2>
      <p id="iaqValue" class="text-2xl sm:text-3xl font-bold text-blue-400">--</p>
    </div>

    <!-- precision de l'indice IAQ -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">IAQ précision</h2>
      <p id="iaqprecisionValue" class="text-2xl sm:text-3xl font-bold text-yellow-400">--</p>
    </div>

    <!-- co2 -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Quantité de CO2</h2>
      <p id="co2value" class="text-2xl sm:text-3xl font-bold text-pink-400">--</p>
    </div>

    <!-- cov -->
    <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col items-center justify-center">
      <h2 class="text-gray-400 mb-2 text-sm sm:text-base">Qualité de COV</h2>
      <p id="vocValue" class="text-2xl sm:text-3xl font-bold text-cyan-400">--</p>
    </div>

  </div>

  <!-- Chart Section -->
  <div class="bg-gray-800 rounded-xl shadow-lg p-6">
    <h2 class="text-xl font-semibold mb-4">Tu te rends comptes ? On a aussi accès à l'historique !</h2>

    <!-- Selection dropdowns -->
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
      <div>
        <label for="variableSelect" class="block text-gray-300 mb-1">Select Variable</label>
        <select id="variableSelect" class="bg-gray-700 text-gray-200 p-2 rounded-lg">
          <option value="temp">Température</option>
          <option value="pressure">Pression</option>
          <option value="humidity">Hygrométrie</option>
          <option value="iaq">IAQ</option>
          <option value="iaqp">IAQ précision</option>
          <option value="co2">CO2</option>
          <option value="voc">VOC</option>
        </select>
      </div>
      <div>
        <label for="timeRange" class="block text-gray-300 mb-1">Select Time Range</label>
        <select id="timeRange" class="bg-gray-700 text-gray-200 p-2 rounded-lg">
          <option value="hour">Heure</option>
          <option value="day">Jour</option>
          <option value="week" selected>Semaine</option>
          <option value="month">Mois</option>
          <option value="year">Année</option>
        </select>
      </div>
    </div>

    <canvas id="dataChart"></canvas>
  </div>
</main>

<script>
const apiKey = "EAG5JSOPGG6TUX2V";
const channelID = "3110199";
const results = 100000;
let chart;

// Fetch data from ThingSpeak
async function getData() {
  const res = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${apiKey}&results=${results}`);
  const data = await res.json();
  return data.feeds;
}

// Update dashboard and chart
async function updateDashboard() {
  const feeds = await getData();
  const latest = feeds[feeds.length - 1];

  // Update live values
  document.getElementById('tempValue').innerText = parseFloat(latest.field1).toFixed(2) + " °C";
  document.getElementById('pressureValue').innerText = parseFloat(latest.field2).toFixed(2) + " hPa";
  document.getElementById('moistureValue').innerText = parseFloat(latest.field3).toFixed(2) + " %";
  document.getElementById('iaqValue').innerText = parseFloat(latest.field4).toFixed(2);
  document.getElementById('iaqprecisionValue').innerText = parseFloat(latest.field5).toFixed(2);
  document.getElementById('co2value').innerText = parseFloat(latest.field6).toFixed(2) + " ppm";
  document.getElementById('vocValue').innerText = parseFloat(latest.field7).toFixed(2) + " ppm";
  document.getElementById('lastUpdate').innerText = "Les dernières données météorologiques datent de : " + new Date(latest.created_at).toLocaleString();

// Event listeners
["variableSelect"].forEach(id => {
  document.getElementById(id).addEventListener('change', updateDashboard);
});

// Initial load and refresh
updateDashboard();
setInterval(updateDashboard, 30000);
</script>
</body>
</html>
